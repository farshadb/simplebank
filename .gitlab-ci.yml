image: docker:19.03.12

services:
  - docker:19.03.12-dind

variables:
  DOCKER_DRIVER: overlay2
  POSTGRES_USER: root
  POSTGRES_PASSWORD: secret
  POSTGRES_DB: simplebank
  POSTGRES_PORT: 5432
  POSTGRES_HOST: postgres

cache:
  paths:
    - .go/cache

before_script:
  - "which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )"
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$SSH_PRIVATE_KEY")
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

stages:
  - prepare
  - build
  - test

prepare:
  stage: prepare
  image: golang:1.21.4
  script:
    - go mod download
    - go mod verify
  cache:
    key: ${CI_COMMIT_REF_SLUG}-go-modules
    paths:
      - .go/cache

build:
  stage: build
  image: golang:1.21.4
  script:
    - go build -o app .
  artifacts:
    paths:
      - app

test:
  stage: test
  image: golang:1.21.4
  services:
    - postgres:16-alpine
  script:
    - curl -L https://github.com/golang-migrate/migrate/releases/download/v4.16.2/migrate.linux-amd64.tar.gz | tar xvz
    - mv migrate /bin/migrate
    - which migrate
    - make migrateup
    - sudo systemctl enable postgresql
    - sudo systemctl restart postgresql
    - sudo systemctl status postgresql
    - go mod tidy
    - PGPASSWORD=$POSTGRES_PASSWORD make test
  only:
    - master
  variables:
    POSTGRES_PASSWORD: secret
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
